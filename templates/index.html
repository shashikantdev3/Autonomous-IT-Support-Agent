<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Autonomous IT Support Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div class="container">
        <header>
            <h1>Automation to Autonomy</h1>
            <p class="subtitle">Your Autonomous IT Support System</p>
        </header>

        {% if message %}
        <div class="status-message">
            <p>{{ message }}</p>
        </div>
        {% endif %}

        <main>
            <form action="/submit" method="POST" class="issue-form">
                <label for="issue">Describe Your IT Issue</label>
                <textarea id="issue" name="issue" placeholder="Example: VPN not connecting, disk space full..." required></textarea>
                <button type="submit">Submit Issue</button>
            </form>

            {% if result %}
            <div class="result-box">
                <h2>Agent Response</h2>

                {% if result.category %}
                    <p><strong>Category:</strong> {{ result.category }}</p>
                {% endif %}

                {% if result.result.reasoning %}
                    <p><strong>Reasoning:</strong> {{ result.result.reasoning }}</p>
                {% endif %}

                {% if result.category and result.category.lower() == "general_query" %}
                    {% if result.result.server_outputs %}
                        <h3>General Query Results</h3>
                        {% for server, info in result.result.server_outputs.items() %}
                            <div class="server-block">
                                <h4>{{ server }} {% if info.ip %}({{ info.ip }}){% endif %}</h4>
                                {% if info.services %}
                                    <p><strong>Services:</strong> {{ info.services | join(', ') }}</p>
                                {% endif %}
                                {% if info.output %}
                                    <pre><code>{{ info.output }}</code></pre>
                                {% endif %}
                            </div>
                        {% endfor %}
                    {% else %}
                        <p>No server outputs returned.</p>
                    {% endif %}
                {% elif result.category and result.category.lower() == "needs_resolution" %}
                    <h3>Issue Resolution</h3>
                    {% if result.resolution %}
                        <p><strong>Affected Service:</strong> {{ result.resolution.service }}</p>
                        <p><strong>Summary:</strong> {{ result.resolution.summary }}</p>

                        {% if result.resolution.steps %}
                            <p><strong>Resolution Steps:</strong></p>
                            <ul>
                                {% for step in result.resolution.steps %}
                                    <li>{{ step }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}

                        <p><strong>Reasoning:</strong> {{ result.resolution.reasoning }}</p>
                    {% endif %}

                    {% if result.validation %}
                        <h4>Validation</h4>
                        <p><strong>Notes:</strong> {{ result.validation.review_notes }}</p>
                        <p><strong>Status:</strong>
                            {% if result.execution and result.execution.status == "awaiting_user_approval" %}
                                ⏳ Awaiting User Confirmation
                            {% elif result.validation.approved %}
                                ✅ Approved
                            {% else %}
                                ❌ Not Approved
                            {% endif %}
                        </p>
                    {% else %}
                        <p><em>Awaiting validation from validator agent...</em></p>
                    {% endif %}

                    {% if result.execution %}
                        <p><strong>Execution Status:</strong> {{ result.execution.status }}</p>
                    {% endif %}
                {% else %}
                    <p><strong>Response:</strong> No specific category matched this issue.</p>
                {% endif %}
            </div>
            {% endif %}
        </main>
    </div>
</body>
</html>
